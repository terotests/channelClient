(function(){var t={},n=function(){var n=function(){!function(t){var n,i,e,r,a;t.add=function(t,n,e){if(n||e){var r;"[object Array]"===Object.prototype.toString.call(e)?r=e:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),i.push([n,t,r])}else i.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,i){i||(i="time"+(new Date).getTime()+Math.random(1e7)),r[i]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,s;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),i=[],e={},r={},a=[];var o=0,c=function(){for(var n,s=(new Date).getTime();n=i.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var _=0;_<a.length;_++){var f=a[_];f()}for(var h in e)if(e.hasOwnProperty(h)){var u=e[h];u[0](u[1]),delete e[h]}for(var h in r)if(r.hasOwnProperty(h)){var u=r[h];u.nextTime<s&&(u.fn(),u.nextTime=s+u.step),u.until&&u.until<s&&delete r[h]}t(c),o=s};c(),n=!0}}),t.once=function(t,n,i){e[t]=[n,i]},t.onFrame=function(t){a.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=a.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),a.splice(n,1),!0):!1}}(this)},i=function(t,n,e,r,a,s,o,c){var _,f=this;if(!(f instanceof i))return new i(t,n,e,r,a,s,o,c);var h=[t,n,e,r,a,s,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,h)}),"function"==typeof _){if(_._classInfo.name!=i._classInfo.name)return new _(t,n,e,r,a,s,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,h)}):"function"==typeof f.init&&f.init.apply(f,h)};i._classInfo={name:"later"},i.prototype=new n;var e=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var i=n.length,e=0,a=[],s=new Array(i);return this.then(function(){var t=r();return 0==n.length&&t.resolve([]),n.forEach(function(n,r){n.then?(a.push(n),n.then(function(n){s[r]=n,e++,e==i&&t.resolve(s)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,i){var e;e=this.isArray(n)?n:[n];var a=e.length,s=!1,o=!1,c=0,_=[],f=i||{};return this.then(function(){var n=r();return e.forEach(function(i){i.then?(_.push(i),i.then(function(i){c++,s=t(i,f),(s&&!o||0==o&&a==c)&&(n.resolve(f),o=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var i=this._childPromises.shift();if(i._onFulfill)try{var e=i._onFulfill(t);"undefined"!=typeof e?i.resolve(e):i.fulfill(t)}catch(r){i.reject(r)}else i.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var e=this;i().asap(function(){t(function(t){e.resolve(t)},function(t){e.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var i=this._childPromises.shift();if(i._onReject)try{i._onReject(t),i.reject(t)}catch(e){i.reject(e)}else i.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var i=!1;try{var n=this;t.then.call(t,function(t){i||(n.resolve(t),i=!0)},function(t){i||(n.reject(t),i=!0)})}catch(e){i||this.reject(e)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var e=new r(t,n),a=this;return 1==this._state&&i().asap(function(){a.fulfill(a.value())}),2==this._state&&i().asap(function(){a.reject(a.rejectReason())}),this._childPromises.push(e),e},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},r=function(t,n,i,e,a,s,o,c){var _,f=this;if(!(f instanceof r))return new r(t,n,i,e,a,s,o,c);var h=[t,n,i,e,a,s,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,h)}),"function"==typeof _){if(_._classInfo.name!=r._classInfo.name)return new _(t,n,i,e,a,s,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,h)}):"function"==typeof f.init&&f.init.apply(f,h)};r._classInfo={name:"_promise"},r.prototype=new e;var a=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t._getNsFromUrl=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getNsShorthand=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getReflections=function(){return _localReflections},t._getReflectionsFor=function(t){if(_localReflections){var n=_localReflections[t];if(n)return n}return[]},t._getReverseNs=function(t){return _nsReverse[t]},t._idFromNs=function(t){if(t){var n=t.length;"#"==t[n-1]&&(t=t.split("@").shift())}return t},t._idToNs=function(t,n){if(t){var i=t.length;if("#"==t[i-1]){var e=t.indexOf("@"),r=t.substring(e+1,i-1);r!=n&&(t=t.substring(0,e)+"@"+n+"#")}else t=t+"@"+n+"#"}return t},t._nsFromId=function(t){var n;if(t){t+="";var i=t.length;"#"==t[i-1]&&(n=t.split("@").pop(),n=n.split("#").shift())}return n},t._transformCmdFromNs=function(t,i){i||(i=this._ns);var e=n,r=t.slice(),a=e[t[0]],s=this;return a&&a.forEach(function(t){r[t]=s._idFromNs(r[t],i)}),r},t._transformCmdToNs=function(t,i){i||(i=this._ns);var e=n,r=t.slice(),a=e[t[0]];if(a)for(var s=0;s<a.length;s++){var o=a[s];r[o]=this._idToNs(r[o],i)}return r},t._transformObjFromNs=function(t,n){if(t&&t.__id){t.__id=this._idFromNs(t.__id,n);for(var i in t.data)t.data.hasOwnProperty(i)&&this.isObject(t.data[i])&&this._transformObjFromNs(t.data[i],n)}return t},t._transformObjToNs=function(t,n){if(t&&t.__id){t.__id=this._idToNs(t.__id,n),t.__p&&(t.__p=this._idToNs(t.__p,n));for(var i in t.data)t.data.hasOwnProperty(i)&&this.isObject(t.data[i])&&this._transformObjToNs(t.data[i],n)}return t},t._transformToNsBeforeInsert=function(t,n){var i=t.__ctxCmdList,e=this._nsFromId(n.__id);console.log(" _transformToNsBeforeInsert ");var r=this;return e?(i&&i.forEach(function(t){t.cmd=r._transformCmdToNs(t.cmd,e)}),t=r._transformObjToNs(t,e),t.__ctxCmdList=i,this._addToCache(t),t):t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={1:[1],2:[1],4:[4],5:[2,4],7:[2,4],8:[2,4],10:[2,4],12:[1,4],13:[4],16:[3,4]})})}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,i){return t&&i?(t+=i.getId(),n||(n={}),n[t]?n[t]:void(n[t]=this)):void 0}),t._createTransaction=function(){this._currentFrame={id:this.guid(),version:1,from:this._data.getJournalLine(),fail_tolastok:!0,commands:[]}},t._fetch=function(t){var n=this._idToNs(t,this._ns),i=this._data._find(n);return i?i:void 0},t._incoming=function(t,n){var i=this,e=this._channelId;t.on("frame_"+e,function(e){var r=e.data,a=i._data;console.log("--- incoming to "+t.getEnum()+"--- "),console.log(JSON.stringify(e));var s=i._data.getJournalLine();if(s==r.from)return console.log("--- incoming ok --- "),void r.commands.forEach(function(t){i._data.execCmd(i._transformCmdToNs(t,n))&&i._currentFrame.from++});if(console.log("--- incoming had problems --- "),i._pendingFrames.length>0){console.log("--- there were pending frames --- "),i._pendingFrames.forEach(function(t){t._didFail=!0}),a.reverseToLine(r.from);for(var o=0;o<r.commands.length;o++){var e=r.commands[o];if(!i._data.execCmd(i._transformCmdToNs(e,n))){console.error("syncing frames failed, buffer out of order");break}f++}return console.log("--- done --- "),void i._createTransaction()}console.log("--- trying to run cmds  --- ");var c=a._journal.splice(r.from,s-r.from),_=a._journalPointer;a._journalPointer-=s-r.from;for(var f=0,h=r.commands.length,u=!1,o=0;h>o;o++){var e=r.commands[o];if(!i._data.execCmd(i._transformCmdToNs(e,n))){u=!0;break}f++}if(u){console.log("--- run failed  --- "),i._data.undo(f),a._journalPointer=_;for(var o,l=c.length;o=c.shift();)a._journal.push(o);a.undo(l),u=!1;for(var o=0;h>o;o++){var e=r.commands[o];if(!i._data.execCmd(i._transformCmdToNs(e,n))){console.error("syncing frames failed, buffer out of order");break}f++}}else{console.log("--- run was ok  --- "),i._currentFrame.from=a._journalPointer,a._journalPointer+=c.length;for(var o;o=c.shift();)a._journal.push(o)}})},t._onFrameLoop=function(t){var n=this,e=this._channelId;i().onFrame(function(){if(n._currentFrame&&n._currentFrame.commands.length){var i=n._currentFrame;n._pendingFrames.push(n._currentFrame),t.send("channelCommand",{channelId:e,cmd:"changeFrame",data:n._currentFrame}).then(function(e){console.log("Command response "+t.getEnum()),console.log(JSON.stringify(i)),console.log(JSON.stringify(e));var r=n._pendingFrames.indexOf(i);if(n._pendingFrames.splice(r,1),e.result){if(console.log("---- ok ---- "),e.correctLines&&e.correctLines.length){var a=e.correctStart;console.log("---- rolling back JUST IN CASE ---- "),n._data.reverseToLine(a),e.correctLines.forEach(function(t){n._data.execCmd(n._transformCmdToNs(t,n._ns))})}}else if(e.correctLines&&e.correctLines.length){var a=e.correctStart;console.log("---- rolling back ---- "),n._data.reverseToLine(a),e.correctLines.forEach(function(t){n._data.execCmd(n._transformCmdToNs(t,n._ns))}),n._createTransaction()}else console.log("---- failed, but no rollback ---- ")}),n._createTransaction()}})},t.addCommand=function(t){if(this._currentFrame){var n=this._transformCmdFromNs(t,this._ns),i=this._transformCmdToNs(t,this._ns);this._data.execCmd(i)&&this._currentFrame.commands.push(n)}else{var i=this._transformCmdToNs(t,this._ns);this._data.execCmd(i)}},t.at=function(t,n){var i=this._idToNs(t,this._ns),e=this._data._find(i);return e?e.data[n]:void 0},t.get=function(t,n){var i=this._idToNs(t,this._ns),e=this._data._find(i);return e?e.data[n]:void 0},t.getChannelData=function(){return this._data},t.getData=function(){return this._data.getData()},t.indexOf=function(t){var n=this._idToNs(t,this._ns),i=this._data._find(n);if(i){var e=this._fetch(i.__p);if(e&&e.data){var r=e.data.indexOf(i);return r}}return-1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,i){if(i&&i.localChannel){this._channelId=t,this._options=i,this._socketGUID=this.guid(),this._socket=_clientSocket(this._socketGUID,1);var e=this._socket.getEnum();this._ns=e,this._id=t+this._socket.getId();var r=this,a=i.localData;a=r._transformObjToNs(i.localData,e);var s=_channelData(r._id,a,[]);return r._data=s,void r.resolve({result:!0,channelId:t})}if(t&&n){this._channelId=t,this._socket=n,this._options=i,this._changeFrames=[],this._pendingFrames=[];var e=n.getEnum();this._ns=e,this._id=t+n.getId();var r=this;this._onFrameLoop(n,e),this._incoming(n,e),n.on("connect",function(){i.auth&&n.send("auth",{userId:i.auth.username,password:i.auth.password}).then(function(i){return i.userId?(r._userId=i.userId,r._logged=!0,n.send("requestChannel",{channelId:t})):!1}).then(function(i){return i&&i.channelId==t?(r._connected=!0,n.send("channelCommand",{channelId:t,cmd:"readBuildTree",data:""})):!1}).then(function(n){if(n){var i=n.pop();i=r._transformObjToNs(i,e);for(var a=_channelData(r._id,i,[]),s=n.pop();s;)a._journalPointer=0,a._journal.length=0,s.forEach(function(t){a.execCmd(r._transformCmdToNs(t,e))}),s=n.pop();r._data=a,r._createTransaction(),r.resolve({result:!0,channelId:t})}else r.resolve({result:!1,text:"Authorization or connection failed"})})})}}),t.length=function(t){var n=this._idToNs(t,this._ns),i=this._data._find(n);return i&&i.data?i.data.length||0:0},t.moveDown=function(t){var n=this._idToNs(t,this._ns),i=this._data._find(n);if(i){var e=this._fetch(i.__p);if(e&&e.data){var r=e.data.indexOf(i),a=r-1;a>=0&&r>=0&&r!=a&&e.data.length>a&&this.addCommand([12,n,a,r,e.__id])}}},t.moveTo=function(t,n){var i=this._idToNs(t,this._ns),e=this._data._find(i);if(e){var r=this._fetch(e.__p);if(r&&r.data){var a=r.data.indexOf(e);a>=0&&a!=n&&r.data.length>n&&this.addCommand([12,i,n,a,r.__id])}}},t.moveUp=function(t){var n=this._idToNs(t,this._ns),i=this._data._find(n);if(i){var e=this._fetch(i.__p);if(e&&e.data){var r=e.data.indexOf(i),a=r+1;a>=0&&r>=0&&r!=a&&e.data.length>a&&this.addCommand([12,n,a,r,e.__id])}}},t.redo=function(t){this._data.redo(t)},t.remove=function(t){var n=this._idToNs(t,this._ns),i=this._data._find(n);if(i){var e=this._fetch(i.__p);if(e&&e.data){var r=e.data.indexOf(i);r>=0&&this.addCommand([8,r,n,0,e.__id])}}},t.set=function(t,n,i){var e=this._idToNs(t,this._ns),r=this._data._find(e);if(r&&!this.isObject(i)){var a=r.data[n];a!=i&&this.addCommand([4,n,i,a,e])}},t.setObject=function(t,n,i){var e=this._idToNs(t,this._ns),r=this._data._find(e);if(r&&this.isObject(i)&&i.__id){var a=r.data[n];a||this.addCommand([5,n,i.__id,null,e])}},t.undo=function(t){this._data.undo(t)},t.unset=function(t,n){var i=this._idToNs(t,this._ns),e=this._data._find(i);if(e){var r=e.data[n];r&&r.__id&&this.addCommand([10,n,r.__id,null,i])}}}(this)},s=function(t,n,i,e,r,a,o,c){var _,f=this;if(!(f instanceof s))return new s(t,n,i,e,r,a,o,c);var h=[t,n,i,e,r,a,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,h)}),"function"==typeof _){if(_._classInfo.name!=s._classInfo.name)return new _(t,n,i,e,r,a,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,h)}):"function"==typeof f.init&&f.init.apply(f,h)};a.prototype=r.prototype,s._classInfo={name:"channelClient"},s.prototype=new a,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelClient=s,this.channelClient=s):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelClient=s:this.channelClient=s}.call(new Function("return this")()),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},i=function(t,n,e,r,a,s,o,c){var _,f=this;if(!(f instanceof i))return new i(t,n,e,r,a,s,o,c);var h=[t,n,e,r,a,s,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,h)}),"function"==typeof _){if(_._classInfo.name!=i._classInfo.name)return new _(t,n,e,r,a,s,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,h)}):"function"==typeof f.init&&f.init.apply(f,h)};i._classInfo={name:"channelClientModule"},i.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());
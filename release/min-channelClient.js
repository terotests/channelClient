(function(){var t={},n=function(){var n=function(){!function(t){var n,e,r,i,o;t.add=function(t,n,r){if(n||r){var i;"[object Array]"===Object.prototype.toString.call(r)?i=r:(i=Array.prototype.slice.call(arguments,2),i||(i=[])),e.push([n,t,i])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),i[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,a;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],r={},i={},o=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var l=0;l<o.length;l++){var _=o[l];_()}for(var f in r)if(r.hasOwnProperty(f)){var u=r[f];u[0](u[1]),delete r[f]}for(var f in i)if(i.hasOwnProperty(f)){var u=i[f];u.nextTime<a&&(u.fn(),u.nextTime=a+u.step),u.until&&u.until<a&&delete i[f]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){r[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,r,i,o,a,s,c){var l,_=this;if(!(_ instanceof e))return new e(t,n,r,i,o,a,s,c);var f=[t,n,r,i,o,a,s,c];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){l=t.apply(_,f)}),"function"==typeof l){if(l._classInfo.name!=e._classInfo.name)return new l(t,n,r,i,o,a,s,c)}else if(l)return l;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};e._classInfo={name:"later"},e.prototype=new n;var r=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,r=0,o=[],a=new Array(e);return this.then(function(){var t=i();return 0==n.length&&t.resolve([]),n.forEach(function(n,i){n.then?(o.push(n),n.then(function(n){a[i]=n,r++,r==e&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var r;r=this.isArray(n)?n:[n];var o=r.length,a=!1,s=!1,c=0,l=[],_=e||{};return this.then(function(){var n=i();return r.forEach(function(e){e.then?(l.push(e),e.then(function(e){c++,a=t(e,_),(a&&!s||0==s&&o==c)&&(n.resolve(_),s=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var r=e._onFulfill(t);"undefined"!=typeof r?e.resolve(r):e.fulfill(t)}catch(i){e.reject(i)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var r=this;e().asap(function(){t(function(t){r.resolve(t)},function(t){r.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(r){e.reject(r)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(r){e||this.reject(r)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var r=new i(t,n),o=this;return 1==this._state&&e().asap(function(){o.fulfill(o.value())}),2==this._state&&e().asap(function(){o.reject(o.rejectReason())}),this._childPromises.push(r),r},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},i=function(t,n,e,r,o,a,s,c){var l,_=this;if(!(_ instanceof i))return new i(t,n,e,r,o,a,s,c);var f=[t,n,e,r,o,a,s,c];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){l=t.apply(_,f)}),"function"==typeof l){if(l._classInfo.name!=i._classInfo.name)return new l(t,n,e,r,o,a,s,c)}else if(l)return l;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};i._classInfo={name:"_promise"},i.prototype=new r;var o=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t._getNsFromUrl=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getNsShorthand=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getReflections=function(){return _localReflections},t._getReflectionsFor=function(t){if(_localReflections){var n=_localReflections[t];if(n)return n}return[]},t._getReverseNs=function(t){return _nsReverse[t]},t._idFromNs=function(t){if(t){var n=t.length;"#"==t[n-1]&&(t=t.split("@").shift())}return t},t._idToNs=function(t,n){if(t){var e=t.length;if("#"==t[e-1]){var r=t.indexOf("@"),i=t.substring(r+1,e-1);i!=n&&(t=t.substring(0,r)+"@"+n+"#")}else t=t+"@"+n+"#"}return t},t._nsFromId=function(t){var n;if(t){t+="";var e=t.length;"#"==t[e-1]&&(n=t.split("@").pop(),n=n.split("#").shift())}return n},t._transformCmdFromNs=function(t,e){var r=n,i=t.slice(),o=r[t[0]],a=this;return o&&o.forEach(function(t){i[t]=a._idFromNs(i[t],e)}),i},t._transformCmdToNs=function(t,e){var r=n,i=t.slice(),o=r[t[0]];if(o)for(var a=0;a<o.length;a++){var s=o[a];i[s]=this._idToNs(i[s],e)}return i},t._transformObjFromNs=function(t,n){if(t&&t.__id){t.__id=this._idFromNs(t.__id,n);for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjFromNs(t.data[e],n)}return t},t._transformObjToNs=function(t,n){if(t&&t.__id){t.__id=this._idToNs(t.__id,n),t.__p&&(t.__p=this._idToNs(t.__p,n));for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjToNs(t.data[e],nsNext||n)}return t},t._transformToNsBeforeInsert=function(t,n){var e=t.__ctxCmdList,r=this._nsFromId(n.__id);console.log(" _transformToNsBeforeInsert ");var i=this;return r?(e&&e.forEach(function(t){t.cmd=i._transformCmdToNs(t.cmd,r)}),t=i._transformObjToNs(t,r),t.__ctxCmdList=e,this._addToCache(t),t):t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={1:[1],2:[1],4:[4],5:[2,4],7:[2,4],8:[2,4],10:[2,4],12:[4],13:[4],16:[3,4]})})}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t&&e?(t+=e.getId(),n||(n={}),n[t]?n[t]:void(n[t]=this)):void 0}),t._createTransaction=function(){this._currentFrame={id:this.guid(),version:1,from:this._data.getJournalLine(),fail_tolastok:!0,commands:[]}},t._incoming=function(t,n){var e=this,r=this._channelId;t.on("frame_"+r,function(r){var i=r.data,o=e._data;console.log("--- incoming to "+t.getEnum()+"--- "),console.log(JSON.stringify(r));var a=e._data.getJournalLine();if(a==i.from)return console.log("--- incoming ok --- "),e._logJournal(),i.commands.forEach(function(t){e._data.execCmd(e._transformCmdToNs(t,n))&&e._currentFrame.from++}),e._lastGoodIndex=e._data._journalPointer,void e._logJournal();if(console.log("--- incoming had problems --- "),e._logJournal(),e._pendingFrames.length>0){console.log("--- there were pending frames --- "),e._pendingFrames.forEach(function(t){t._didFail=!0}),o.reverseToLine(i.from);for(var s=0;s<i.commands.length;s++){var c=i.commands[s];if(!e._data.execCmd(e._transformCmdToNs(c,n))){console.error("syncing frames failed, buffer out of order"),console.error(JSON.stringify(c)),console.error(o._data.data[c[1]]);break}f++}return e._lastGoodIndex=e._data._journalPointer,e._logJournal(),console.log("--- done --- "),void e._createTransaction()}console.log("--- trying to run cmds  --- ");var l=o._journal.splice(i.from,a-i.from),_=o._journalPointer;o._journalPointer-=a-i.from;for(var f=0,u=i.commands.length,h=!1,s=0;u>s;s++){var c=i.commands[s];if(!e._data.execCmd(e._transformCmdToNs(c,n))){h=!0;break}f++}if(h){console.log("--- run failed  --- "),e._logJournal(),console.log("OK cnt "+f),e._data.undo(f),o._journalPointer=_;for(var s,d=l.length;s=l.shift();)o._journal.push(s);o.undo(d),h=!1;for(var s=0;u>s;s++){var c=i.commands[s];if(!e._data.execCmd(e._transformCmdToNs(c,n))){console.error("syncing frames failed, buffer out of order"),console.error(JSON.stringify(c)),console.error(o._data.data[c[1]]);break}f++}e._lastGoodIndex=e._data._journalPointer,e._logJournal(),e._createTransaction()}else{console.log("--- run was ok  --- "),e._currentFrame.from=o._journalPointer,o._journalPointer+=l.length;for(var s;s=l.shift();)o._journal.push(s);e._lastGoodIndex=e._data._journalPointer,e._logJournal()}})},t._logJournal=function(){console.log("--- journal "+this._socket.getEnum()+" ---- "),this._data._journal.forEach(function(t,n){console.log(n,t)})},t._onFrameLoop=function(){{var t=this;this._channelId}e().onFrame(function(){t._sendFrame()})},t._sendFrame=function(){var t=this,n=this._channelId,e=this._socket;if(t._currentFrame&&t._currentFrame.commands.length){var r=t._currentFrame;t._pendingFrames.push(t._currentFrame),e.send("channelCommand",{channelId:n,cmd:"changeFrame",data:t._currentFrame}).then(function(n){console.log("Command response "+e.getEnum()),console.log(JSON.stringify(r)),console.log(JSON.stringify(n));var i=t._pendingFrames.indexOf(r);if(t._pendingFrames.splice(i,1),n.result){if(console.log("---- ok ---- "),n.correctLines&&n.correctLines.length){var o=n.correctStart;console.log("---- rolling back JUST IN CASE ---- "),t._logJournal(),t._data.reverseToLine(o),n.correctLines.forEach(function(n){var e=t._transformCmdToNs(n,t._ns);console.log(e),t._data.execCmd(e)||console.error("Failed to execute ",e)}),t._lastGoodIndex=t._data._journalPointer,t._logJournal()}}else if(n.correctLines&&n.correctLines.length){var o=n.correctStart;console.log("---- rolling back to "+o+" ---- "),t._data.reverseToLine(o),n.correctLines.forEach(function(n){t._data.execCmd(t._transformCmdToNs(n,t._ns))}),t._logJournal(),t._createTransaction()}else console.log("---- failed, but no rollback ---- "),t._data.reverseToLine(t._lastGoodIndex)}),t._createTransaction()}},t.addCommand=function(t){if(this._currentFrame){var n=this._transformCmdFromNs(t,this._ns),e=this._transformCmdToNs(t,this._ns);this._data.execCmd(e)&&this._currentFrame.commands.push(n)}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){if(t&&n){this._channelId=t,this._socket=n,this._options=e,this._changeFrames=[],this._pendingFrames=[],this._lastGoodIndex=0;var r=n.getEnum();this._ns=r,this._id=t+n.getId();var i=this;e.manualSend||this._onFrameLoop(n,r),this._incoming(n,r),n.on("connect",function(){e.auth&&n.send("auth",{userId:e.auth.username,password:e.auth.password}).then(function(e){return e.userId?(i._userId=e.userId,i._logged=!0,n.send("requestChannel",{channelId:t})):!1}).then(function(e){return e&&e.channelId==t?(i._connected=!0,n.send("channelCommand",{channelId:t,cmd:"readBuildTree",data:""})):!1}).then(function(n){if(n){var e=n.pop();e=i._transformObjToNs(e,r);for(var o=_channelData(i._id,e,[]),a=n.pop();a;)o._journalPointer=0,o._journal.length=0,a.forEach(function(t){o.execCmd(i._transformCmdToNs(t,r))}),a=n.pop();i._data=o,i._createTransaction(),i._lastGoodIndex=i._data._journalPointer,i.resolve({result:!0,channelId:t})}else i.resolve({result:!1,text:"Authorization or connection failed"})})})}}),t.set=function(t,n,e){var r=this._idToNs(t,this._ns),i=this._data._find(r);if(i){var o=i.data[n];o!=e&&this.addCommand([4,n,e,o,r])}}}(this)},a=function(t,n,e,r,i,o,s,c){var l,_=this;if(!(_ instanceof a))return new a(t,n,e,r,i,o,s,c);var f=[t,n,e,r,i,o,s,c];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){l=t.apply(_,f)}),"function"==typeof l){if(l._classInfo.name!=a._classInfo.name)return new l(t,n,e,r,i,o,s,c)}else if(l)return l;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};o.prototype=i.prototype,a._classInfo={name:"channelClient"},a.prototype=new o,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelClient=a,this.channelClient=a):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelClient=a:this.channelClient=a}.call(new Function("return this")()),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},e=function(t,n,r,i,o,a,s,c){var l,_=this;if(!(_ instanceof e))return new e(t,n,r,i,o,a,s,c);var f=[t,n,r,i,o,a,s,c];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){l=t.apply(_,f)}),"function"==typeof l){if(l._classInfo.name!=e._classInfo.name)return new l(t,n,r,i,o,a,s,c)}else if(l)return l;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};e._classInfo={name:"channelClientModule"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());
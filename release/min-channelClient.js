(function(){var t={},n=function(){var n=function(){!function(t){var n,e,i,a,s;t.add=function(t,n,i){if(n||i){var a;"[object Array]"===Object.prototype.toString.call(i)?a=i:(a=Array.prototype.slice.call(arguments,2),a||(a=[])),e.push([n,t,a])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),a[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,r;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,r=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],r=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),r||(r=function(t){clearTimeout(t)}),e=[],i={},a={},s=[];var o=0,c=function(){for(var n,r=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var _=0;_<s.length;_++){var l=s[_];l()}for(var h in i)if(i.hasOwnProperty(h)){var f=i[h];f[0](f[1]),delete i[h]}for(var h in a)if(a.hasOwnProperty(h)){var f=a[h];f.nextTime<r&&(f.fn(),f.nextTime=r+f.step),f.until&&f.until<r&&delete a[h]}t(c),o=r};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){s.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=s.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),s.splice(n,1),!0):!1}}(this)},e=function(t,n,i,a,s,r,o,c){var _,l=this;if(!(l instanceof e))return new e(t,n,i,a,s,r,o,c);var h=[t,n,i,a,s,r,o,c];if(l.__factoryClass)if(l.__factoryClass.forEach(function(t){_=t.apply(l,h)}),"function"==typeof _){if(_._classInfo.name!=e._classInfo.name)return new _(t,n,i,a,s,r,o,c)}else if(_)return _;l.__traitInit?l.__traitInit.forEach(function(t){t.apply(l,h)}):"function"==typeof l.init&&l.init.apply(l,h)};e._classInfo={name:"later"},e.prototype=new n;var i=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,s=[],r=new Array(e);return this.then(function(){var t=a();return 0==n.length&&t.resolve([]),n.forEach(function(n,a){n.then?(s.push(n),n.then(function(n){r[a]=n,i++,i==e&&t.resolve(r)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var s=i.length,r=!1,o=!1,c=0,_=[],l=e||{};return this.then(function(){var n=a();return i.forEach(function(e){e.then?(_.push(e),e.then(function(e){c++,r=t(e,l),(r&&!o||0==o&&s==c)&&(n.resolve(l),o=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(a){e.reject(a)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new a(t,n),s=this;return 1==this._state&&e().asap(function(){s.fulfill(s.value())}),2==this._state&&e().asap(function(){s.reject(s.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},a=function(t,n,e,i,s,r,o,c){var _,l=this;if(!(l instanceof a))return new a(t,n,e,i,s,r,o,c);var h=[t,n,e,i,s,r,o,c];if(l.__factoryClass)if(l.__factoryClass.forEach(function(t){_=t.apply(l,h)}),"function"==typeof _){if(_._classInfo.name!=a._classInfo.name)return new _(t,n,e,i,s,r,o,c)}else if(_)return _;l.__traitInit?l.__traitInit.forEach(function(t){t.apply(l,h)}):"function"==typeof l.init&&l.init.apply(l,h)};a._classInfo={name:"_promise"},a.prototype=new i;var s=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t._getNsFromUrl=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getNsShorthand=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getReflections=function(){return _localReflections},t._getReflectionsFor=function(t){if(_localReflections){var n=_localReflections[t];if(n)return n}return[]},t._getReverseNs=function(t){return _nsReverse[t]},t._idFromNs=function(t){if(t){var n=t.length;"#"==t[n-1]&&(t=t.split("@").shift())}return t},t._idToNs=function(t,n){if(t){var e=t.length;if("#"==t[e-1]){var i=t.indexOf("@"),a=t.substring(i+1,e-1);a!=n&&(t=t.substring(0,i)+"@"+n+"#")}else t=t+"@"+n+"#"}return t},t._nsFromId=function(t){var n;if(t){t+="";var e=t.length;"#"==t[e-1]&&(n=t.split("@").pop(),n=n.split("#").shift())}return n},t._transformCmdFromNs=function(t,e){e||(e=this._ns);var i=n,a=t.slice(),s=i[t[0]],r=this;return s&&s.forEach(function(t){a[t]=r._idFromNs(a[t],e)}),a},t._transformCmdToNs=function(t,e){e||(e=this._ns);var i=n,a=t.slice(),s=i[t[0]];if(s)for(var r=0;r<s.length;r++){var o=s[r];a[o]=this._idToNs(a[o],e)}return a},t._transformObjFromNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__p&&(t.__p=this._idFromNs(t.__p,n)),t.__id=this._idFromNs(t.__id,n);for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjFromNs(t.data[e],n)}return t},t._transformObjToNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__id=this._idToNs(t.__id,n),t.__p&&(t.__p=this._idToNs(t.__p,n));for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjToNs(t.data[e],n)}return t},t._transformToNsBeforeInsert=function(t,n){var e=t.__ctxCmdList,i=this._nsFromId(n.__id);console.log(" _transformToNsBeforeInsert ");var a=this;return i?(e&&e.forEach(function(t){t.cmd=a._transformCmdToNs(t.cmd,i)}),t=a._transformObjToNs(t,i),t.__ctxCmdList=e,this._addToCache(t),t):t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={1:[1],2:[1],4:[4],5:[2,4],7:[2,4],8:[2,4],10:[2,4],12:[1,4],13:[4],16:[3,4]})})}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t&&e?(t+=e.getId(),n||(n={}),n[t]?n[t]:void(n[t]=this)):void 0}),t._createTransaction=function(){this._currentFrame={id:this.guid(),version:1,from:this._data.getJournalLine(),fail_tolastok:!0,commands:[]}},t._fetch=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e?e:void 0},t._incoming=function(t){{var n=this;this._channelId}t.on("upgrade_"+this._channelId,function(t){if(n._upgradePending=!1,!n._disconnected&&t){if(t.partial){var e=n._clientState.data;e.reverseToLine(t.partialFrom),console.log("--- refreshing the partials, reversed to line --- ",t.partialFrom);var i=0;t.partial.forEach(function(t){if(!(i>0)){var a,s=n._transformCmdToNs(t);(a=e.execCmd(s,!0))!==!0&&(console.error("Partial ",a),i++)}}),0==i?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,e._journal.length=t.partialEnds,n._clientState.last_update[0]=0,n._clientState.last_update[1]=e._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=e._journal.length):n._clientState.needsFullRefresh=!0}if(t.data){var a=n._clientState.data.getData();n._transformObjToNs(t.data);var s=diffEngine().compareFiles(a,t.data);console.log("The diff ",JSON.stringify(s));var e=n._clientState.data,i=0;s.cmds.forEach(function(t){if(console.log("Diff cmd ",t),!(i>0)){var n;(n=e.execCmd(t,!0))!==!0&&(console.error("Full error ",n),i++)}}),0==i?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,console.log("** full update should have gone ok ** "),e._journal.length=0,e._journal.push.apply(e._journal,t.journal),n._clientState.needsRefresh=!1,n._clientState.version=t.version,n._clientState.last_update[0]=0,n._clientState.last_update[1]=e._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=e._journal.length,console.log("Version ",n._clientState.version)):(console.error("** errors with the full update ** "),n._clientState.needsFullRefresh=!0)}}}),t.on("s2c_"+this._channelId,function(t){if(!n._disconnected&&t){n._policy.deltaServerToClient(t,n._clientState)}})},t._onFrameLoop=function(t){var n=this,i=this._channelId,a=function(){if(n._policy&&!n._disconnected){n._clientState.needsRefresh&&(n._upgradePending||(console.log(" needsRefresh && !_upgradePending "),n.askUpgrade(n._clientState.needsFullRefresh)),n._upgradePending=!0);var e=n._policy.constructClientToServer(n._clientState);e&&t.send("channelCommand",{channelId:i,cmd:"c2s",data:e}).then(function(t){if(t&&t.errors&&t.errors.length>0){var e=!1;t.errors.forEach(function(t){44==t.error&&(e=!0)}),e&&(n._clientState.needsRefresh=!0)}})}};e().onFrame(a)},t.addCommand=function(t,n){if(this._currentFrame){var e=this._transformCmdFromNs(t,this._ns),i=this._transformCmdToNs(t,this._ns);this._data.execCmd(i,n)&&this._currentFrame.commands.push(e)}else{var i=this._transformCmdToNs(t,this._ns);this._data.execCmd(i,n)}},t.askUpgrade=function(t){this._socket&&this._socket.send("channelCommand",{channelId:this._channelId,cmd:"upgradeRequest",data:{version:this._clientState.version,last_update:this._clientState.last_update,askFull:t}}).then(function(){})},t.at=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.disconnect=function(){return this._disconnected=!0,this},t.fork=function(t,n){if(!this._isLocal){var e={version:this._channelStatus.version,channelId:t,name:n,journalLine:1};e.journalLine=this._clientState.last_update[1];var i=this;return a(function(t){i._socket.send("channelCommand",{channelId:i._channelId,cmd:"fork",data:e}).then(function(n){t(n)})})}},t.get=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.getChannelData=function(){return this._data},t.getData=function(){return this._data.getData()},t.indexOf=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var a=i.data.indexOf(e);return a}}return-1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){if(console.log("channelClient init starts"),e&&e.localChannel){this._channelId=t,this._options=e,this._socketGUID=this.guid(),this._isLocal=!0,this._socket=_clientSocket(this._socketGUID,1);var i=this._socket.getEnum();this._ns=i,this._id=t+this._socket.getId();var a=this,s=e.localData;s=a._transformObjToNs(e.localData,i);var r=_channelData(a._id,s,[]);return a._data=r,void a.resolve({result:!0,channelId:t})}if(t&&n){this._channelId=t,this._socket=n,this._options=e,this._changeFrames=[],this._pendingFrames=[];var i=n.getEnum();this._ns=i,this._id=t+n.getId();var a=this;this._onFrameLoop(n,i),this._incoming(n,i),console.log("channelClient init"),this._connCnt=0,n.on("connect",function(){console.log("Socket sent connected"),a._connCnt++,e.auth&&n.send("auth",{userId:e.auth.username,password:e.auth.password}).then(function(e){return e.userId?(a._userId=e.userId,a._logged=!0,n.send("requestChannel",{channelId:t})):(a._logged=!1,!1)}).then(function(e){return e&&e.channelId==t?(a._connected=!0,a._connCnt>1?(console.log("Already connected, asking upgrade"),a.askUpgrade(),!1):n.send("channelCommand",{channelId:t,cmd:"readBuildTree",data:""})):!1}).then(function(n){if(n){var e=n.build;console.log("STATUS",JSON.stringify(n.status)),a._channelStatus=n.status;var s=e.pop();s=a._transformObjToNs(s,i);for(var r=_channelData(a._id,s,[]),o=e.pop();o;)r._journalPointer=0,r._journal.length=0,o.forEach(function(t){r.execCmd(a._transformCmdToNs(t,i),!0)}),o=e.pop();a._clientState={data:r,client:a,needsRefresh:!1,version:a._channelStatus.version,last_update:[0,r.getJournalLine()],last_sent:[0,r.getJournalLine()]},a._policy=_chPolicy(),a._data=r,a._createTransaction(),a.resolve({result:!0,channelId:t})}else a.resolve({result:!1,text:"Authorization or connection failed"})})})}}),t.length=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e&&e.data?e.data.length||0:0},t.moveDown=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var a=i.data.indexOf(e),s=a-1;s>=0&&a>=0&&a!=s&&i.data.length>s&&this.addCommand([12,n,s,a,i.__id])}}},t.moveTo=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);if(i){var a=this._fetch(i.__p);if(a&&a.data){var s=a.data.indexOf(i);s>=0&&s!=n&&a.data.length>n&&this.addCommand([12,e,n,s,a.__id])}}},t.moveUp=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var a=i.data.indexOf(e),s=a+1;s>=0&&a>=0&&a!=s&&i.data.length>s&&this.addCommand([12,n,s,a,i.__id])}}},t.reconnect=function(){return this._disconnected=!1,this},t.redo=function(t){this._data.redo(t)},t.remove=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var a=i.data.indexOf(e);a>=0&&this.addCommand([8,a,n,0,i.__id])}}},t.set=function(t,n,e){var i=this._idToNs(t,this._ns),a=this._data._find(i);if(a&&!this.isObject(e)){var s=a.data[n];s!=e&&this.addCommand([4,n,e,s,i])}},t.setObject=function(t,n,e){var i=this._idToNs(t,this._ns),a=this._data._find(i);if(a&&this.isObject(e)&&e.__id){var s=a.data[n];s||this.addCommand([5,n,e.__id,null,i])}},t.undo=function(t){this._data.undo(t)},t.unset=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);if(i){var a=i.data[n];a&&a.__id&&this.addCommand([10,n,a.__id,null,e])}},t.upgradeVersion=function(){this._socket.send("channelCommand",{channelId:this._channelId,cmd:"snapshot",data:{}}).then(function(){})}}(this)},r=function(t,n,e,i,a,s,o,c){var _,l=this;if(!(l instanceof r))return new r(t,n,e,i,a,s,o,c);var h=[t,n,e,i,a,s,o,c];if(l.__factoryClass)if(l.__factoryClass.forEach(function(t){_=t.apply(l,h)}),"function"==typeof _){if(_._classInfo.name!=r._classInfo.name)return new _(t,n,e,i,a,s,o,c)}else if(_)return _;l.__traitInit?l.__traitInit.forEach(function(t){t.apply(l,h)}):"function"==typeof l.init&&l.init.apply(l,h)};s.prototype=a.prototype,r._classInfo={name:"channelClient"},r.prototype=new s,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelClient=r,this.channelClient=r):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelClient=r:this.channelClient=r}.call(new Function("return this")()),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},e=function(t,n,i,a,s,r,o,c){var _,l=this;if(!(l instanceof e))return new e(t,n,i,a,s,r,o,c);var h=[t,n,i,a,s,r,o,c];if(l.__factoryClass)if(l.__factoryClass.forEach(function(t){_=t.apply(l,h)}),"function"==typeof _){if(_._classInfo.name!=e._classInfo.name)return new _(t,n,i,a,s,r,o,c)}else if(_)return _;l.__traitInit?l.__traitInit.forEach(function(t){t.apply(l,h)}):"function"==typeof l.init&&l.init.apply(l,h)};e._classInfo={name:"channelClientModule"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());